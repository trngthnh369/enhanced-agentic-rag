# ğŸš€ Enhanced Agentic RAG System 2.0

## Tá»•ng Quan

Há»‡ thá»‘ng Enhanced Agentic RAG 2.0 lÃ  má»™t nÃ¢ng cáº¥p toÃ n diá»‡n cá»§a há»‡ thá»‘ng RAG truyá»n thá»‘ng, tÃ­ch há»£p kháº£ nÄƒng **suy luáº­n Ä‘a bÆ°á»›c**, **Ä‘Ã¡nh giÃ¡ cháº¥t lÆ°á»£ng**, vÃ  **truy xuáº¥t thÃ´ng tin thÃ´ng minh** cho cá»­a hÃ ng Ä‘iá»‡n thoáº¡i di Ä‘á»™ng Viá»‡t Nam.

## âœ¨ TÃ­nh NÄƒng NÃ¢ng Cao

### ğŸ§  Workflow Suy Luáº­n Äa BÆ°á»›c
```
Query Input â†’ Query Rewriting â†’ Need Assessment â†’ Source Selection â†’ 
Information Retrieval â†’ Response Generation â†’ Quality Evaluation â†’ 
Final Response (hoáº·c láº·p láº¡i náº¿u chÆ°a Ä‘áº¡t cháº¥t lÆ°á»£ng)
```

### ğŸ¯ Há»‡ Thá»‘ng Agent ThÃ´ng Minh
- **Enhanced Product Agent**: TÆ° váº¥n sáº£n pháº©m vá»›i kháº£ nÄƒng suy luáº­n cao
- **Enhanced Shop Info Agent**: ThÃ´ng tin cá»­a hÃ ng real-time tá»« Google Sheets
- **Intelligent Router**: Äá»‹nh tuyáº¿n thÃ´ng minh vá»›i Ä‘iá»ƒm tin cáº­y

### ğŸ” Nguá»“n ThÃ´ng Tin Äa Dáº¡ng
- **Vector Database (ChromaDB)**: ThÃ´ng tin sáº£n pháº©m, giÃ¡ cáº£, thÃ´ng sá»‘
- **Google Sheets**: ThÃ´ng tin cá»­a hÃ ng real-time
- **Internet Search (SerpAPI)**: TÃ¬m kiáº¿m thÃ´ng tin má»›i nháº¥t

### ğŸ“Š ÄÃ¡nh GiÃ¡ Cháº¥t LÆ°á»£ng Tá»± Äá»™ng
- ÄÃ¡nh giÃ¡ Ä‘á»™ liÃªn quan cá»§a cÃ¢u tráº£ lá»i
- Cáº£i thiá»‡n láº·p Ä‘i láº·p láº¡i cho Ä‘áº¿n khi Ä‘áº¡t cháº¥t lÆ°á»£ng
- Theo dÃµi metrics hiá»‡u suáº¥t

## ğŸ› ï¸ CÃ i Äáº·t & Thiáº¿t Láº­p

### BÆ°á»›c 1: Chuáº©n Bá»‹ MÃ´i TrÆ°á»ng
```bash
# Clone repository vÃ  di chuyá»ƒn vÃ o thÆ° má»¥c
cd enhanced-agentic-rag

# Táº¡o virtual environment (khuyáº¿n nghá»‹)
python -m venv venv
source venv/bin/activate  # Linux/Mac
# hoáº·c
venv\Scripts\activate     # Windows
```

### BÆ°á»›c 2: Cháº¡y Setup Tá»± Äá»™ng
```bash
python enhanced_setup.py
```

Script sáº½ tá»± Ä‘á»™ng:
- âœ… Kiá»ƒm tra phiÃªn báº£n Python
- ğŸ“¦ CÃ i Ä‘áº·t dependencies
- ğŸ” Kiá»ƒm tra files cáº§n thiáº¿t
- ğŸ”‘ XÃ¡c minh API keys
- ğŸ—„ï¸ Thiáº¿t láº­p vector database
- ğŸ§ª Test há»‡ thá»‘ng
- ğŸ“š Táº¡o documentation

### BÆ°á»›c 3: Cáº¥u HÃ¬nh API Keys

Táº¡o file `.env`:
```bash
# Required: Google Gemini API Key
GEMINI_API_KEY=your_gemini_api_key_here

# Optional: SerpAPI for internet search
SERPAPI_KEY=your_serpapi_key_here

# System Configuration
MAX_ITERATIONS=3
ENABLE_INTERNET_SEARCH=True
ENABLE_QUALITY_EVALUATION=True
```

### BÆ°á»›c 4: Khá»Ÿi Cháº¡y Há»‡ Thá»‘ng
```bash
python enhanced_run.py
```

Chá»n tÃ¹y chá»n:
1. **Server only** - Chá»‰ cháº¡y API server
2. **UI only** - Chá»‰ cháº¡y giao diá»‡n Streamlit  
3. **Both** - Cháº¡y cáº£ server vÃ  UI (khuyáº¿n nghá»‹)
4. **Interactive Test** - Test cÃ¡c tÃ­nh nÄƒng enhanced
5. **System Status** - Kiá»ƒm tra tráº¡ng thÃ¡i há»‡ thá»‘ng

## ğŸ“ Cáº¥u TrÃºc Dá»± Ãn

```
enhanced-agentic-rag/
â”œâ”€â”€ enhanced_rag.py              # Core Enhanced RAG system
â”œâ”€â”€ enhanced_gemini_serve.py     # Enhanced API server
â”œâ”€â”€ enhanced_client.py           # Enhanced Streamlit UI
â”œâ”€â”€ enhanced_setup.py            # Automated setup script
â”œâ”€â”€ enhanced_run.py              # System launcher
â”œâ”€â”€ .env                         # Environment variables
â”œâ”€â”€ requirements.txt             # Python dependencies
â”œâ”€â”€ hoanghamobile.csv           # Product database
â”œâ”€â”€ mles-class-12c1216b7303.json # Google Sheets credentials
â”œâ”€â”€ db/                         # Vector database
â””â”€â”€ ENHANCED_README.md          # Detailed documentation
```

## ğŸ”§ Chi Tiáº¿t Ká»¹ Thuáº­t

### Enhanced RAG Workflow

#### 1. Query Rewriting (Viáº¿t Láº¡i CÃ¢u Há»i)
```python
def rewrite_query(self, original_query: str, context: str = "") -> str:
    # Tá»‘i Æ°u hÃ³a cÃ¢u há»i Ä‘á»ƒ tÃ¬m kiáº¿m hiá»‡u quáº£ hÆ¡n
    # VÃ­ dá»¥: "Nokia giÃ¡ bao nhiÃªu" â†’ "Nokia 3210 4G giÃ¡ cáº£ thÃ´ng sá»‘ ká»¹ thuáº­t"
```

#### 2. Information Need Assessment (ÄÃ¡nh GiÃ¡ Nhu Cáº§u ThÃ´ng Tin)
```python
def need_additional_info(self, query: str) -> bool:
    # Quyáº¿t Ä‘á»‹nh cÃ³ cáº§n truy xuáº¥t thÃ´ng tin bá»• sung khÃ´ng
    # YES: Cáº§n database/internet search
    # NO: CÃ³ thá»ƒ tráº£ lá»i báº±ng kiáº¿n thá»©c chung
```

#### 3. Source Selection (Chá»n Nguá»“n ThÃ´ng Tin)
```python
def determine_information_source(self, query: str) -> List[InformationSource]:
    # Chá»n nguá»“n thÃ´ng tin phÃ¹ há»£p:
    # - VECTOR_DATABASE: Sáº£n pháº©m, giÃ¡ cáº£
    # - SHOP_INFO: Äá»‹a chá»‰, giá» má»Ÿ cá»­a
    # - INTERNET: ThÃ´ng tin má»›i nháº¥t
```

#### 4. Quality Evaluation (ÄÃ¡nh GiÃ¡ Cháº¥t LÆ°á»£ng)
```python
def evaluate_response_quality(self, query: str, response: str) -> Tuple[bool, str]:
    # ÄÃ¡nh giÃ¡ cÃ¢u tráº£ lá»i cÃ³:
    # - Tráº£ lá»i Ä‘Ãºng trá»ng tÃ¢m
    # - ThÃ´ng tin chÃ­nh xÃ¡c vÃ  Ä‘áº§y Ä‘á»§
    # - LiÃªn quan trá»±c tiáº¿p Ä‘áº¿n cÃ¢u há»i
```

### API Endpoints

#### Enhanced Chat
```http
POST /chat
Content-Type: application/json

{
  "message": "Nokia 3210 4G cÃ³ giÃ¡ bao nhiÃªu?",
  "thread_id": "optional-thread-id"
}
```

**Response:**
```json
{
  "role": "assistant",
  "content": "Nokia 3210 4G cÃ³ giÃ¡ 1,590,000 â‚«...",
  "enhanced_processing": true,
  "routing_info": {
    "agent_used": "ENHANCED_PRODUCT",
    "confidence": "HIGH",
    "reasoning": "Product price inquiry detected",
    "complexity": "MEDIUM"
  },
  "processing_info": {
    "processing_time": 2.34,
    "agent_name": "Enhanced Product Assistant",
    "enhanced_features": [
      "Multi-step reasoning",
      "Quality evaluation",
      "Information need assessment"
    ]
  }
}
```

#### System Health
```http
GET /health
```

#### Enhanced Statistics
```http
GET /stats
```

## ğŸ§ª Testing & Debugging

### Interactive Testing
```bash
python enhanced_run.py
# Chá»n option 4: Run Interactive Test
```

### API Testing
```bash
# Test basic connection
curl -X GET http://localhost:5001/health

# Test enhanced features
curl -X GET http://localhost:5001/test-enhanced

# Test chat
curl -X POST http://localhost:5001/chat \
  -H "Content-Type: application/json" \
  -d '{"message": "Nokia 3210 4G cÃ³ giÃ¡ bao nhiÃªu?"}'
```

### Debug Logs
Há»‡ thá»‘ng cung cáº¥p logs chi tiáº¿t:
```
ğŸš€ Starting Enhanced RAG Processing
ğŸ“ Original query: Nokia 3210 4G cÃ³ giÃ¡ bao nhiÃªu?
ğŸ”„ Query rewritten: Nokia 3210 4G giÃ¡ cáº£ thÃ´ng sá»‘ ká»¹ thuáº­t khuyáº¿n mÃ£i
ğŸ“Š Need additional info: True
ğŸ¯ Selected sources: ['vector_database']
ğŸ—„ï¸ Vector DB result length: 1250 chars
ğŸ’¬ Generated response length: 420 chars
â­ Response quality: True
âœ… Response approved after 1 iteration(s)
```

## ğŸ“Š Metrics & Monitoring

### Performance Metrics
- **Processing Time**: Thá»i gian xá»­ lÃ½ tá»«ng request
- **Quality Scores**: Äiá»ƒm cháº¥t lÆ°á»£ng cÃ¢u tráº£ lá»i
- **Confidence Levels**: Má»©c Ä‘á»™ tin cáº­y routing
- **Agent Usage**: Thá»‘ng kÃª sá»­ dá»¥ng agents
- **Iteration Counts**: Sá»‘ láº§n láº·p Ä‘á»ƒ Ä‘áº¡t cháº¥t lÆ°á»£ng

### Streamlit Dashboard
- Real-time conversation analytics
- Processing time trends
- Agent usage distribution
- Quality score tracking
- System health monitoring

## ğŸ”’ Báº£o Máº­t & Hiá»‡u Suáº¥t

### Security Features
- API key management qua environment variables
- No persistent user data storage
- Secure Google Sheets integration
- Request timeout vÃ  rate limiting

### Performance Optimization
- Intelligent caching cho repeated queries
- Batch processing cho embeddings
- Context-aware conversation management
- Resource-efficient multi-iteration processing

## ğŸš¨ Troubleshooting

### Common Issues

#### 1. Gemini API Connection Error
```bash
âŒ Gemini API connection failed: 401 Unauthorized
```
**Solution:** Kiá»ƒm tra `GEMINI_API_KEY` trong file `.env`

#### 2. Vector Database Missing
```bash
âš ï¸ Vector database not found
```
**Solution:** Cháº¡y láº¡i `python enhanced_setup.py`

#### 3. Internet Search Disabled
```bash
âš ï¸ No SerpAPI key - Internet search disabled
```
**Solution:** ThÃªm `SERPAPI_KEY` vÃ o `.env` file

#### 4. Google Sheets Integration Error
```bash
âŒ Error in retrieve_shop_info
```
**Solution:** Kiá»ƒm tra file `mles-class-12c1216b7303.json`

### Performance Issues

#### Slow Processing
- Giáº£m `MAX_ITERATIONS` trong `.env`
- Disable internet search náº¿u khÃ´ng cáº§n thiáº¿t
- Kiá»ƒm tra network connectivity

#### Memory Usage
- Restart há»‡ thá»‘ng sau má»—i 1000+ queries
- Clear conversation history thÆ°á»ng xuyÃªn
- Monitor system resources

## ğŸ”„ Updates & Maintenance

### Regular Maintenance
```bash
# Update product database
python enhanced_setup.py  # Step 5 only

# Clear conversation history
rm -rf conversation_cache/

# Update vector embeddings
python update_embeddings.py
```

### System Updates
1. Backup existing configuration
2. Update code files
3. Run enhanced_setup.py
4. Test with enhanced_run.py option 4

## ğŸ¤ Contributing

### Development Setup
1. Fork repository
2. Create feature branch
3. Implement enhancements
4. Add comprehensive tests
5. Submit PR with performance benchmarks

### Code Standards
- Type hints for all functions
- Comprehensive error handling
- Performance monitoring
- Documentation for new features

## ğŸ“ Support

### Getting Help
1. **System Health**: Check `/health` endpoint
2. **Enhanced Testing**: Run `/test-enhanced`
3. **Debug Logs**: Enable detailed logging
4. **Documentation**: See `ENHANCED_README.md`

### Reporting Issues
Include in bug reports:
- System configuration (OS, Python version)
- Error logs and stack traces
- API response examples
- Performance metrics

---

## ğŸ¯ Use Cases

### 1. Product Consultation
```
User: "TÃ´i cáº§n Ä‘iá»‡n thoáº¡i dÆ°á»›i 2 triá»‡u cÃ³ camera tá»‘t"
System: 
- Rewrites: "Äiá»‡n thoáº¡i giÃ¡ dÆ°á»›i 2 triá»‡u camera cháº¥t lÆ°á»£ng cao khuyáº¿n mÃ£i"
- Sources: Vector database + Internet search
- Response: Detailed product comparison vá»›i recommendations
```

### 2. Shop Information
```
User: "Cá»­a hÃ ng má»Ÿ cá»­a lÃºc nÃ o?"
System:
- Sources: Google Sheets real-time data
- Response: Complete schedule vá»›i special hours
```

### 3. Complex Comparisons
```
User: "So sÃ¡nh Nokia 3210 vÃ  Samsung A05s vá» pin vÃ  camera"
System:
- Multi-step reasoning Ä‘á»ƒ gather product specs
- Quality evaluation Ä‘á»ƒ ensure comprehensive comparison
- Iterative improvement náº¿u cáº§n thÃªm thÃ´ng tin
```

---

**Enhanced Agentic RAG System 2.0** - Powered by Google Gemini 2.0 Flash with advanced reasoning capabilities.

*Created with â¤ï¸ for intelligent conversational AI*